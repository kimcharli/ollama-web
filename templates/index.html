<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Vision & Text Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Global variables
        let defaultPrompt = "{{ default_prompt | default('') | safe }}";
        let promptSuggestions = {{ prompt_suggestions | default([]) | tojson | safe }};
        let prompts = {{ prompts | default({'vision_models': {'default': '', 'suggestions': []}, 'text_models': {'default': '', 'suggestions': []}}) | tojson | safe }};
        let isDropdownOpen = false;
        let isAnalyzing = false;

        console.log('Initial defaultPrompt:', defaultPrompt);
        console.log('Initial promptSuggestions:', promptSuggestions);
        console.log('Initial prompts:', prompts);

        // Form submission handling
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[action="/analyze"]');
            const submitButton = form.querySelector('button[type="submit"]');
            const loadingDiv = document.getElementById('loading');
            const abortButton = document.getElementById('abortButton');
            
            form.addEventListener('submit', function(e) {
                if (isAnalyzing) {
                    e.preventDefault();
                    return;
                }
                
                isAnalyzing = true;
                submitButton.disabled = true;
                submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitButton.textContent = 'Analyzing...';
                loadingDiv.classList.remove('hidden');
                abortButton.classList.remove('hidden');
            });

            // Abort button handling
            abortButton.addEventListener('click', function() {
                fetch('/abort', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Reset UI state
                        isAnalyzing = false;
                        submitButton.disabled = false;
                        submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                        submitButton.textContent = 'Analyze';
                        loadingDiv.classList.add('hidden');
                        abortButton.classList.add('hidden');
                    } else {
                        console.error('Error aborting:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });

        // Model selection handling
        function handleModelChange(event) {
            const model = event.target.value;
            console.log('Model changed to:', model);
            
            const formData = new FormData();
            formData.append('model', model);
            formData.append('csrf_token', '{{ csrf_token() }}');
            
            fetch('/select_model', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Select model response:', data);
                if (data.status === 'success') {
                    defaultPrompt = data.default_prompt;
                    promptSuggestions = data.prompt_suggestions;
                    
                    console.log('Updated defaultPrompt:', defaultPrompt);
                    console.log('Updated promptSuggestions:', promptSuggestions);
                    
                    // Update prompt input
                    const promptInput = document.getElementById('prompt');
                    if (!promptInput.value || promptInput.value === defaultPrompt) {
                        promptInput.value = defaultPrompt;
                    }
                    
                    // Update dropdown
                    updatePromptDropdown();
                    
                    // Update UI based on model type
                    updateModelType();
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Prompt dropdown handling
        function toggleDropdown(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropdown = document.getElementById('promptDropdown');
            const button = document.getElementById('promptDropdownButton');
            
            if (dropdown && button) {
                isDropdownOpen = !isDropdownOpen;
                console.log('Toggling dropdown:', isDropdownOpen);
                
                if (isDropdownOpen) {
                    dropdown.classList.remove('hidden');
                    button.setAttribute('aria-expanded', 'true');
                    updatePromptDropdown();
                } else {
                    dropdown.classList.add('hidden');
                    button.setAttribute('aria-expanded', 'false');
                }
            }
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function(event) {
            const dropdown = document.getElementById('promptDropdown');
            const button = document.getElementById('promptDropdownButton');
            
            if (!dropdown || !button) return;
            
            if (!button.contains(event.target) && !dropdown.contains(event.target)) {
                isDropdownOpen = false;
                dropdown.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        });

        function updatePromptDropdown() {
            const dropdown = document.getElementById('promptDropdown');
            if (!dropdown) return;
            
            console.log('Updating dropdown with suggestions:', promptSuggestions);
            
            // Clear existing items
            dropdown.innerHTML = '';
            
            if (!promptSuggestions || promptSuggestions.length === 0) {
                const item = document.createElement('div');
                item.className = 'px-4 py-2 text-sm text-gray-500';
                item.textContent = 'No suggestions available';
                dropdown.appendChild(item);
                return;
            }
            
            // Add suggestions to dropdown
            promptSuggestions.forEach(suggestion => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500';
                item.textContent = suggestion;
                item.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    setPrompt(suggestion);
                };
                dropdown.appendChild(item);
            });
        }

        function setPrompt(prompt) {
            console.log('Setting prompt to:', prompt);
            const promptInput = document.getElementById('prompt');
            if (promptInput) {
                promptInput.value = prompt;
                promptInput.focus();
            }
            isDropdownOpen = false;
            const dropdown = document.getElementById('promptDropdown');
            const button = document.getElementById('promptDropdownButton');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            if (button) {
                button.setAttribute('aria-expanded', 'false');
            }
        }

        // Update UI based on model type
        function updateModelType() {
            const modelSelect = document.getElementById('model');
            const selectedModel = modelSelect.value;
            
            console.log('Selected model:', selectedModel);
            
            // Show file upload section for all models
            const fileSection = document.getElementById('fileSection');
            const fileRequired = document.getElementById('fileRequired');
            const fileDescription = document.getElementById('fileDescription');
            
            if (fileSection) {
                fileSection.style.display = 'block';
                fileRequired.textContent = '(Optional)';
                fileDescription.textContent = 'Upload an image to analyze';
            }
        }

        // Initialize dropdown and event handlers on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - Initializing dropdown');
            
            // Initialize dropdown
            updatePromptDropdown();
            
            // Add model change handler
            const modelSelect = document.getElementById('model');
            if (modelSelect) {
                console.log('Adding model change handler');
                modelSelect.addEventListener('change', handleModelChange);
            }
            
            // Add click handler for prompt dropdown button
            const promptDropdownButton = document.getElementById('promptDropdownButton');
            if (promptDropdownButton) {
                console.log('Adding prompt dropdown button handler');
                promptDropdownButton.addEventListener('click', toggleDropdown);
            }
            
            // Update model type
            updateModelType();
        });
    </script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-6 flex flex-col justify-center sm:py-12">
        <div class="relative py-3 sm:max-w-xl sm:mx-auto">
            <div class="relative px-4 py-10 bg-white mx-8 md:mx-0 shadow rounded-3xl sm:p-10">
                <div class="max-w-md mx-auto">
                    <div class="divide-y divide-gray-200">
                        <div class="py-8 text-base leading-6 space-y-4 text-gray-700 sm:text-lg sm:leading-7">
                            <h1 class="text-2xl font-bold text-center mb-8 text-indigo-600">Ollama Vision & Text Analysis</h1>
                            
                            <!-- Navigation -->
                            <div class="flex justify-between items-center mb-8">
                                <a href="/" class="text-indigo-600 hover:text-indigo-500 font-medium flex items-center">
                                    <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                                    </svg>
                                    Home
                                </a>
                                <div class="relative inline-block text-left">
                                    <button type="button" id="debugButton"
                                        class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                        onclick="toggleDebugDropdown()">
                                        Debug Level: {{ current_debug_level }}
                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <div id="debugDropdown"
                                        class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none"
                                        role="menu" aria-orientation="vertical" aria-labelledby="debugButton">
                                        <div class="py-1" role="none">
                                            {% for level in debug_levels %}
                                            <button type="button"
                                                class="text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 {% if level == current_debug_level %}bg-gray-100{% endif %}"
                                                role="menuitem"
                                                onclick="setDebugLevel('{{ level }}')">
                                                {{ level }}
                                            </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Content -->
                            <div class="space-y-8">
                                <!-- Current Analysis Section -->
                                <div class="bg-white shadow sm:rounded-lg">
                                    <div class="px-4 py-5 sm:p-6">
                                        <form method="post" action="/analyze" enctype="multipart/form-data">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            
                                            <!-- Model Selection -->
                                            <div class="mb-6">
                                                <label for="model" class="block text-sm font-medium text-gray-700">Select Model:</label>
                                                <select id="model" name="model" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    {% for model in models %}
                                                        <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div id="modelMessage" class="hidden mt-2 text-sm"></div>
                                            </div>

                                            <!-- File Upload Section -->
                                            <div id="fileSection" class="mb-6">
                                                <div class="flex items-center">
                                                    <label id="fileLabel" for="file" class="block text-sm font-medium text-gray-700">Upload File:</label>
                                                    <span id="fileRequired" class="ml-2 text-sm text-gray-500">(Optional)</span>
                                                </div>
                                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                    <div class="space-y-1 text-center">
                                                        <div class="flex text-sm text-gray-600">
                                                            <label for="file" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                                                <span>Upload a file</span>
                                                                <input id="file" name="file" type="file" class="sr-only">
                                                            </label>
                                                        </div>
                                                        <p id="fileDescription" class="text-xs text-gray-500">Upload an image to analyze</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Prompt input and suggestions -->
                                            <div class="space-y-2">
                                                <div class="relative">
                                                    <textarea id="prompt" name="prompt" rows="3"
                                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                                        placeholder="Enter your prompt here...">{{ default_prompt }}</textarea>
                                                </div>
                                                
                                                <!-- Prompt Suggestions Dropdown -->
                                                <div class="relative inline-block text-left mt-2">
                                                    <button type="button" id="promptDropdownButton"
                                                        class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                                        aria-expanded="false"
                                                        aria-haspopup="true">
                                                        Suggested Prompts
                                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                        </svg>
                                                    </button>
                                                    <div id="promptDropdown"
                                                        class="hidden origin-top-right absolute right-0 mt-2 w-96 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10"
                                                        role="menu"
                                                        aria-orientation="vertical"
                                                        aria-labelledby="promptDropdownButton">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Submit Button -->
                                            <div class="flex justify-center space-x-4">
                                                <button type="submit" 
                                                    class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                                    {% if isAnalyzing %}disabled{% endif %}>
                                                    <span>Analyze</span>
                                                </button>
                                                <button type="button" 
                                                    id="abortButton"
                                                    class="hidden inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                                    onclick="return false;">
                                                    Abort
                                                </button>
                                            </div>
                                        </form>

                                        <!-- Loading indicator -->
                                        <div id="loading" class="hidden mt-6">
                                            <div class="flex items-center justify-center space-x-3 bg-gray-50 p-4 rounded-md">
                                                <div class="animate-spin rounded-full h-8 w-8 border-4 border-indigo-500 border-t-transparent"></div>
                                                <p id="loadingText" class="text-gray-700">Processing...</p>
                                            </div>
                                        </div>

                                        <!-- Results Section -->
                                        {% if result %}
                                        <div class="mt-6">
                                            <h2 class="text-lg font-medium text-gray-900 mb-2">Results:</h2>
                                            <div class="bg-gray-50 rounded-lg p-4">
                                                <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ result }}</pre>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- History Section -->
                                {% if history %}
                                <div class="bg-white shadow sm:rounded-lg mt-8 history-section">
                                    <div class="px-4 py-5 sm:p-6">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg leading-6 font-medium text-gray-900">Analysis History</h3>
                                            <button 
                                                onclick="clearHistory()"
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                            >
                                                Clear History
                                            </button>
                                        </div>
                                        <div class="space-y-4">
                                            {% for item in history|reverse %}
                                            <div class="border rounded-lg p-4 {% if item.success %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %}">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div class="text-sm text-gray-500">{{ item.timestamp }}</div>
                                                    <div class="text-sm font-medium {% if item.success %}text-green-700{% else %}text-red-700{% endif %}">
                                                        {{ item.model }}
                                                    </div>
                                                </div>
                                                <div class="flex justify-between items-start gap-2">
                                                    <div class="text-sm font-medium text-gray-900 mb-2 flex-grow">{{ item.prompt }}</div>
                                                    <button 
                                                        onclick="reusePrompt('{{ item.prompt|replace("'", "\\'") }}', '{{ item.model }}')"
                                                        class="shrink-0 text-sm text-indigo-600 hover:text-indigo-500 focus:outline-none"
                                                    >
                                                        Reuse Prompt
                                                    </button>
                                                </div>
                                                <div id="history-content-{{ loop.index }}" class="text-sm text-gray-600 whitespace-pre-wrap h-32 overflow-hidden transition-all duration-200">{{ item.result }}</div>
                                                <div class="flex justify-between items-center mt-2">
                                                    <div class="text-xs text-gray-500">Duration: {{ "%.2f"|format(item.duration|default(0.0)) }}s</div>
                                                    <button 
                                                        id="history-toggle-{{ loop.index }}"
                                                        onclick="toggleHistoryItem('{{ loop.index }}')"
                                                        class="text-sm text-indigo-600 hover:text-indigo-500 focus:outline-none"
                                                        aria-expanded="false"
                                                    >
                                                        Show More
                                                    </button>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
